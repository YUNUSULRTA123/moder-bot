import time
import sqlite3
from datetime import datetime, timedelta

ROLES = {
    "newbie": "ðŸ‘¶ ÐÐ¾Ð²Ð¸Ñ‡Ð¾Ðº",
    "member": "ðŸ§‘ Ð£Ñ‡Ð°ÑÑ‚Ð½Ð¸Ðº",
    "active": "â­ ÐÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¹",
    "moder": "ðŸ›¡ï¸ ÐœÐ¾Ð´ÐµÑ€Ð°Ñ‚Ð¾Ñ€"
}

class BotModer:
    def __init__(self, db_path="roles.db"):
        self.conn = sqlite3.connect(db_path, check_same_thread=False)
        self.cur = self.conn.cursor()
        self._create_tables()
    def _create_tables(self):
        self.cur.execute("""
        CREATE TABLE IF NOT EXISTS users (
            user_id INTEGER PRIMARY KEY,
            messages INTEGER DEFAULT 0,
            join_date TEXT,
            role TEXT DEFAULT 'newbie'
        )
        """)
        self.conn.commit()
    def add_user(self, user_id):
        self.cur.execute("SELECT user_id FROM users WHERE user_id=?", (user_id,))
        if not self.cur.fetchone():
            self.cur.execute(
                "INSERT INTO users (user_id, join_date) VALUES (?, ?)",
                (user_id, datetime.utcnow().isoformat())
            )
            self.conn.commit()
    def get_user(self, user_id):
        self.cur.execute("SELECT * FROM users WHERE user_id=?", (user_id,))
        return self.cur.fetchone()
    def set_role(self, user_id, role_key):
        self.cur.execute("UPDATE users SET role=? WHERE user_id=?", (role_key, user_id))
        self.conn.commit()
    def add_message(self, user_id):
        self.cur.execute("UPDATE users SET messages = messages + 1 WHERE user_id=?", (user_id,))
        self.conn.commit()
    def auto_update_role(self, user_id):
        user = self.get_user(user_id)
        if not user:
            return None
        _, messages, join_date, role = user
        join_date = datetime.fromisoformat(join_date)

        if role == "newbie" and messages >= 50:
            self.set_role(user_id, "member")
            return ROLES["member"]
        
        if role == "member" and datetime.utcnow() - join_date >= timedelta(days=7):
            self.set_role(user_id, "active")
            return ROLES["active"]
        return None
    def make_moder(self, user_id):
        self.set_role(user_id, "moder")
        return ROLES["moder"]
    def remove_role(self, user_id):
        self.set_role(user_id, "newbie")
        return ROLES["newbie"]
